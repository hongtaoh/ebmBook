<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>4&nbsp; Estimate Distribution Parameters – Event Based Models for Disease Progression</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05_estStages.html" rel="next">
<link href="./03_gen.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script src="site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./04_estDistParams.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Estimate Distribution Parameters</span></a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Event Based Models for Disease Progression</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02_ebmExplain.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">EBM Explained</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03_gen.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Generate Synthetic Data</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04_estDistParams.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Estimate Distribution Parameters</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05_estStages.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Estimate Participant Stages</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06_estS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Estimate S</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07_copKMeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Estimate <span class="math inline">\(S\)</span> with Constrained K-Means</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./08_softKMeans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Estimate <span class="math inline">\(S\)</span> with Soft K-Means</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./09_conjugatePriors.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Estimate <span class="math inline">\(S\)</span> with Conjugate Priors</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./10_aggResults.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Final Results</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#sec-cop-kmeans" id="toc-sec-cop-kmeans" class="nav-link active" data-scroll-target="#sec-cop-kmeans"><span class="header-section-number">4.1</span> Constrained K-Means</a></li>
  <li><a href="#sec-conjugate-priors" id="toc-sec-conjugate-priors" class="nav-link" data-scroll-target="#sec-conjugate-priors"><span class="header-section-number">4.2</span> Conjugate Priors</a></li>
  <li><a href="#sec-soft-kmeans" id="toc-sec-soft-kmeans" class="nav-link" data-scroll-target="#sec-soft-kmeans"><span class="header-section-number">4.3</span> Soft K-Means</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4.4</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-estimate-dist-params" class="quarto-section-identifier"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Estimate Distribution Parameters</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<p>Given <span class="math inline">\(S\)</span>, and a biomarker’s measurements, how can we estimate <span class="math inline">\(\mathcal N(\theta_{\mu}, \theta_{\sigma})\)</span> and <span class="math inline">\(\mathcal N(\phi_{\mu}, \phi_{\sigma})\)</span>?</p>
<div id="cell-1" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt </span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> altair <span class="im">as</span> alt </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> math </span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> norm</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> copkmeans.cop_kmeans <span class="im">import</span> cop_kmeans</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Dict</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> re </span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> collections <span class="im">import</span> defaultdict</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-2" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> <span class="st">'data'</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(<span class="ss">f"</span><span class="sc">{</span>output_dir<span class="sc">}</span><span class="ss">/150|200_3.csv"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>biomarkers <span class="op">=</span> df.biomarker.unique()</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>idx <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>biomarker_df <span class="op">=</span> df[df.biomarker<span class="op">==</span>biomarkers[idx]]</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>biomarker_df.sample(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">participant</th>
<th data-quarto-table-cell-role="th">biomarker</th>
<th data-quarto-table-cell-role="th">measurement</th>
<th data-quarto-table-cell-role="th">k_j</th>
<th data-quarto-table-cell-role="th">S_n</th>
<th data-quarto-table-cell-role="th">affected_or_not</th>
<th data-quarto-table-cell-role="th">diseased</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">230</td>
<td>30</td>
<td>PCC-FCI</td>
<td>17.183986</td>
<td>0</td>
<td>2</td>
<td>not_affected</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">353</td>
<td>153</td>
<td>PCC-FCI</td>
<td>2.348147</td>
<td>6</td>
<td>2</td>
<td>affected</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">397</td>
<td>197</td>
<td>PCC-FCI</td>
<td>10.062496</td>
<td>0</td>
<td>2</td>
<td>not_affected</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">232</td>
<td>32</td>
<td>PCC-FCI</td>
<td>12.526359</td>
<td>0</td>
<td>2</td>
<td>not_affected</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">316</td>
<td>116</td>
<td>PCC-FCI</td>
<td>15.028866</td>
<td>0</td>
<td>2</td>
<td>not_affected</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">305</td>
<td>105</td>
<td>PCC-FCI</td>
<td>3.762252</td>
<td>7</td>
<td>2</td>
<td>affected</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">260</td>
<td>60</td>
<td>PCC-FCI</td>
<td>12.884854</td>
<td>0</td>
<td>2</td>
<td>not_affected</td>
<td>False</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">277</td>
<td>77</td>
<td>PCC-FCI</td>
<td>9.669905</td>
<td>0</td>
<td>2</td>
<td>not_affected</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">367</td>
<td>167</td>
<td>PCC-FCI</td>
<td>3.031575</td>
<td>5</td>
<td>2</td>
<td>affected</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">208</td>
<td>8</td>
<td>PCC-FCI</td>
<td>10.352851</td>
<td>0</td>
<td>2</td>
<td>not_affected</td>
<td>False</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-3" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>biomarker_df.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="33">
<pre><code>(200, 7)</code></pre>
</div>
</div>
<section id="sec-cop-kmeans" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="sec-cop-kmeans"><span class="header-section-number">4.1</span> Constrained K-Means</h2>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>To use this algorithm, we only need to know (1) whether this participant is diseased; and (2) each biomarker measurement.</p>
</div>
</div>
<p>The first method we can use is constrained K-means, implemented by <span class="citation" data-cites="behrouz_babaki_2017_831850">Babaki (<a href="references.html#ref-behrouz_babaki_2017_831850" role="doc-biblioref">2017</a>)</span>.</p>
<p>We choose constrained K-Means instead of the standard K-Means algorithm because we know all healthy participants have to belong to the same cluster. The constrained K-Means algorithm can satisfy this constraint.</p>
<div id="cell-5" class="cell" data-execution_count="34">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_theta_phi_for_biomarker(biomarker_df, max_attempt <span class="op">=</span> <span class="dv">100</span>):</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""get theta and phi parameters for this biomarker using constrained k-means</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">    input: </span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">        - biomarker_df: a pd.dataframe of a specific biomarker</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">    output: </span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">        - a tuple: theta_mean, theta_std, phi_mean, phi_std</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    n_clusters <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    measurements <span class="op">=</span> np.array(biomarker_df[<span class="st">'measurement'</span>]).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    healthy_df <span class="op">=</span> biomarker_df[biomarker_df[<span class="st">'diseased'</span>] <span class="op">==</span> <span class="va">False</span>]</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    must_link <span class="op">=</span> [(x, <span class="dv">0</span>) <span class="cf">for</span> x <span class="kw">in</span> healthy_df.index]</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Implement Constrained K-means algorithm</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># https://github.com/Behrouz-Babaki/COP-Kmeans</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    curr_attempt <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> curr_attempt <span class="op">&lt;</span> max_attempt:</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        clusters, centers <span class="op">=</span> cop_kmeans(</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            dataset<span class="op">=</span>measurements, k<span class="op">=</span>n_clusters, ml<span class="op">=</span>must_link)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        predictions <span class="op">=</span> np.array(clusters)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        healthy_predictions <span class="op">=</span> predictions[healthy_df.index]</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        cluster_counts <span class="op">=</span> np.bincount(predictions)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">all</span>(</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>            c <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">for</span> c <span class="kw">in</span> cluster_counts) <span class="kw">and</span> <span class="bu">len</span>(</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>                cluster_counts) <span class="op">==</span> n_clusters <span class="kw">and</span> <span class="bu">len</span>(</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">set</span>(healthy_predictions)) <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">break</span> </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        curr_attempt <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> curr_attempt <span class="op">&gt;</span> <span class="dv">2</span>:</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(curr_attempt)</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># double check the result</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">all</span>(c <span class="op">&gt;</span> <span class="dv">1</span> <span class="cf">for</span> c <span class="kw">in</span> cluster_counts):</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Not all clusters have more than one node."</span>)</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(cluster_counts) <span class="op">!=</span> n_clusters:</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Number of clusters is not equal to </span><span class="sc">{</span>n_clusters<span class="sc">}</span><span class="ss">."</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(<span class="bu">set</span>(healthy_predictions)) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="st">"Not all healthy participants belong to one cluster."</span>)</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>    phi_cluster_idx <span class="op">=</span> healthy_predictions[<span class="dv">0</span>]</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>    theta_cluster_idx <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> phi_cluster_idx</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># two empty clusters to strore measurements</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>    clustered_measurements <span class="op">=</span> [[] <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">2</span>)]</span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Store measurements into their cluster</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, prediction <span class="kw">in</span> <span class="bu">enumerate</span>(predictions):</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>        clustered_measurements[prediction].append(measurements[i][<span class="dv">0</span>])</span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>     <span class="co"># Calculate means and standard deviations</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a>    theta_mean, theta_std <span class="op">=</span> np.mean(</span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>        clustered_measurements[theta_cluster_idx]), np.std(</span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>            clustered_measurements[theta_cluster_idx])</span>
<span id="cb5-53"><a href="#cb5-53" aria-hidden="true" tabindex="-1"></a>    phi_mean, phi_std <span class="op">=</span> np.mean(</span>
<span id="cb5-54"><a href="#cb5-54" aria-hidden="true" tabindex="-1"></a>        clustered_measurements[phi_cluster_idx]), np.std(</span>
<span id="cb5-55"><a href="#cb5-55" aria-hidden="true" tabindex="-1"></a>            clustered_measurements[phi_cluster_idx])</span>
<span id="cb5-56"><a href="#cb5-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-57"><a href="#cb5-57" aria-hidden="true" tabindex="-1"></a>    <span class="co"># check whether the prior_theta_phi contain 0s or nan</span></span>
<span id="cb5-58"><a href="#cb5-58" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> math.isnan(theta_std) <span class="kw">or</span> theta_std <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-59"><a href="#cb5-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid theta_std: </span><span class="sc">{</span>theta_std<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-60"><a href="#cb5-60" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> math.isnan(phi_std) <span class="kw">or</span> phi_std <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb5-61"><a href="#cb5-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid phi_std: </span><span class="sc">{</span>phi_std<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-62"><a href="#cb5-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> theta_mean <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> math.isnan(theta_mean):</span>
<span id="cb5-63"><a href="#cb5-63" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid theta_mean: </span><span class="sc">{</span>theta_mean<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-64"><a href="#cb5-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> phi_mean <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> math.isnan(phi_mean):</span>
<span id="cb5-65"><a href="#cb5-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">raise</span> <span class="pp">ValueError</span>(<span class="ss">f"Invalid phi_mean: </span><span class="sc">{</span>phi_mean<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-66"><a href="#cb5-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-67"><a href="#cb5-67" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> theta_mean, theta_std, phi_mean, phi_std</span>
<span id="cb5-68"><a href="#cb5-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-69"><a href="#cb5-69" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_theta_phi_estimates(</span>
<span id="cb5-70"><a href="#cb5-70" aria-hidden="true" tabindex="-1"></a>    data: pd.DataFrame,</span>
<span id="cb5-71"><a href="#cb5-71" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> Dict[<span class="bu">str</span>, Dict[<span class="bu">str</span>, <span class="bu">float</span>]]:</span>
<span id="cb5-72"><a href="#cb5-72" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb5-73"><a href="#cb5-73" aria-hidden="true" tabindex="-1"></a><span class="co">    Obtain theta and phi estimates (mean and standard deviation) for each biomarker.</span></span>
<span id="cb5-74"><a href="#cb5-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-75"><a href="#cb5-75" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb5-76"><a href="#cb5-76" aria-hidden="true" tabindex="-1"></a><span class="co">    data (pd.DataFrame): DataFrame containing participant data with columns 'participant', </span></span>
<span id="cb5-77"><a href="#cb5-77" aria-hidden="true" tabindex="-1"></a><span class="co">        'biomarker', 'measurement', and 'diseased'.</span></span>
<span id="cb5-78"><a href="#cb5-78" aria-hidden="true" tabindex="-1"></a><span class="co">    # biomarkers (List[str]): A list of biomarker names.</span></span>
<span id="cb5-79"><a href="#cb5-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-80"><a href="#cb5-80" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb5-81"><a href="#cb5-81" aria-hidden="true" tabindex="-1"></a><span class="co">    Dict[str, Dict[str, float]]: A dictionary where each key is a biomarker name,</span></span>
<span id="cb5-82"><a href="#cb5-82" aria-hidden="true" tabindex="-1"></a><span class="co">        and each value is another dictionary containing the means and standard deviations </span></span>
<span id="cb5-83"><a href="#cb5-83" aria-hidden="true" tabindex="-1"></a><span class="co">        for theta and phi of that biomarker, with keys 'theta_mean', 'theta_std', 'phi_mean', </span></span>
<span id="cb5-84"><a href="#cb5-84" aria-hidden="true" tabindex="-1"></a><span class="co">        and 'phi_std'.</span></span>
<span id="cb5-85"><a href="#cb5-85" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb5-86"><a href="#cb5-86" aria-hidden="true" tabindex="-1"></a>    <span class="co"># empty hashmap of dictionaries to store the estimates</span></span>
<span id="cb5-87"><a href="#cb5-87" aria-hidden="true" tabindex="-1"></a>    estimates <span class="op">=</span> {}</span>
<span id="cb5-88"><a href="#cb5-88" aria-hidden="true" tabindex="-1"></a>    biomarkers <span class="op">=</span> data.biomarker.unique()</span>
<span id="cb5-89"><a href="#cb5-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> biomarker <span class="kw">in</span> biomarkers:</span>
<span id="cb5-90"><a href="#cb5-90" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Filter data for the current biomarker</span></span>
<span id="cb5-91"><a href="#cb5-91" aria-hidden="true" tabindex="-1"></a>        <span class="co"># reset_index is necessary here because we will use healthy_df.index later</span></span>
<span id="cb5-92"><a href="#cb5-92" aria-hidden="true" tabindex="-1"></a>        biomarker_df <span class="op">=</span> data[data[<span class="st">'biomarker'</span>]</span>
<span id="cb5-93"><a href="#cb5-93" aria-hidden="true" tabindex="-1"></a>                            <span class="op">==</span> biomarker].reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-94"><a href="#cb5-94" aria-hidden="true" tabindex="-1"></a>        theta_mean, theta_std, phi_mean, phi_std <span class="op">=</span> compute_theta_phi_for_biomarker(</span>
<span id="cb5-95"><a href="#cb5-95" aria-hidden="true" tabindex="-1"></a>            biomarker_df)</span>
<span id="cb5-96"><a href="#cb5-96" aria-hidden="true" tabindex="-1"></a>        estimates[biomarker] <span class="op">=</span> {</span>
<span id="cb5-97"><a href="#cb5-97" aria-hidden="true" tabindex="-1"></a>            <span class="st">'theta_mean'</span>: theta_mean,</span>
<span id="cb5-98"><a href="#cb5-98" aria-hidden="true" tabindex="-1"></a>            <span class="st">'theta_std'</span>: theta_std,</span>
<span id="cb5-99"><a href="#cb5-99" aria-hidden="true" tabindex="-1"></a>            <span class="st">'phi_mean'</span>: phi_mean,</span>
<span id="cb5-100"><a href="#cb5-100" aria-hidden="true" tabindex="-1"></a>            <span class="st">'phi_std'</span>: phi_std</span>
<span id="cb5-101"><a href="#cb5-101" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb5-102"><a href="#cb5-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> estimates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-6" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>cop_kmeans_estimates <span class="op">=</span> get_theta_phi_estimates(data <span class="op">=</span> df)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>cop_kmeans_estimates_df <span class="op">=</span> pd.DataFrame.from_dict(</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    cop_kmeans_estimates, orient<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>cop_kmeans_estimates_df.reset_index(names <span class="op">=</span> <span class="st">'biomarker'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>cop_kmeans_estimates_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">biomarker</th>
<th data-quarto-table-cell-role="th">theta_mean</th>
<th data-quarto-table-cell-role="th">theta_std</th>
<th data-quarto-table-cell-role="th">phi_mean</th>
<th data-quarto-table-cell-role="th">phi_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>HIP-FCI</td>
<td>-8.587833</td>
<td>5.365053</td>
<td>4.903437</td>
<td>2.008974</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>PCC-FCI</td>
<td>16.330398</td>
<td>0.720160</td>
<td>10.507041</td>
<td>4.427907</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AB</td>
<td>152.194375</td>
<td>15.344414</td>
<td>252.969562</td>
<td>50.946400</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>P-Tau</td>
<td>-71.767059</td>
<td>15.231429</td>
<td>-23.737466</td>
<td>16.637657</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>MMSE</td>
<td>22.164115</td>
<td>1.555676</td>
<td>27.994652</td>
<td>0.832845</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>ADAS</td>
<td>-20.582091</td>
<td>3.853234</td>
<td>-6.002048</td>
<td>1.487443</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>HIP-GMI</td>
<td>0.114735</td>
<td>0.106857</td>
<td>0.404924</td>
<td>0.235082</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>AVLT-Sum</td>
<td>60.569081</td>
<td>6.389012</td>
<td>38.169767</td>
<td>14.373474</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>FUS-GMI</td>
<td>0.478209</td>
<td>0.041763</td>
<td>0.596322</td>
<td>0.059436</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>FUS-FCI</td>
<td>-19.200644</td>
<td>4.688806</td>
<td>-9.568412</td>
<td>3.003514</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-7" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(<span class="st">'files/real_theta_phi.json'</span>, <span class="st">'r'</span>) <span class="im">as</span> f:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    truth <span class="op">=</span> json.load(f)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>truth_df <span class="op">=</span> pd.DataFrame.from_dict(truth, orient<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>truth_df.reset_index(names <span class="op">=</span> <span class="st">'biomarker'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>truth_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">biomarker</th>
<th data-quarto-table-cell-role="th">theta_mean</th>
<th data-quarto-table-cell-role="th">theta_std</th>
<th data-quarto-table-cell-role="th">phi_mean</th>
<th data-quarto-table-cell-role="th">phi_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>MMSE</td>
<td>22.0</td>
<td>2.666667</td>
<td>28.0</td>
<td>0.666667</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>ADAS</td>
<td>-20.0</td>
<td>4.000000</td>
<td>-6.0</td>
<td>1.333333</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AB</td>
<td>150.0</td>
<td>16.666667</td>
<td>250.0</td>
<td>50.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>P-Tau</td>
<td>-50.0</td>
<td>33.333333</td>
<td>-25.0</td>
<td>16.666667</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>HIP-FCI</td>
<td>-5.0</td>
<td>6.666667</td>
<td>5.0</td>
<td>1.666667</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>HIP-GMI</td>
<td>0.3</td>
<td>0.333333</td>
<td>0.4</td>
<td>0.233333</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>AVLT-Sum</td>
<td>20.0</td>
<td>6.666667</td>
<td>40.0</td>
<td>15.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>PCC-FCI</td>
<td>5.0</td>
<td>3.333333</td>
<td>12.0</td>
<td>4.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>FUS-GMI</td>
<td>0.5</td>
<td>0.066667</td>
<td>0.6</td>
<td>0.066667</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>FUS-FCI</td>
<td>-20.0</td>
<td>6.000000</td>
<td>-10.0</td>
<td>3.333333</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Now let’s compare the results using plots:</p>
<div id="cell-9" class="cell" data-execution_count="37">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> obtain_theta_phi_params(biomarker, estimate_df, truth):</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''This is to obtain both true and estimated theta and phi params for each biomarker '''</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    biomarker_data_est <span class="op">=</span> estimate_df[estimate_df.biomarker <span class="op">==</span> biomarker].reset_index()</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    biomarker_data <span class="op">=</span> truth[truth.biomarker <span class="op">==</span> biomarker].reset_index()</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># theta for affected</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    theta_mean_est <span class="op">=</span> biomarker_data_est.theta_mean[<span class="dv">0</span>]</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    theta_std_est <span class="op">=</span> biomarker_data_est.theta_std[<span class="dv">0</span>]</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    theta_mean <span class="op">=</span> biomarker_data.theta_mean[<span class="dv">0</span>]</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    theta_std <span class="op">=</span> biomarker_data.theta_std[<span class="dv">0</span>]</span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># phi for not affected</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    phi_mean_est <span class="op">=</span> biomarker_data_est.phi_mean[<span class="dv">0</span>]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>    phi_std_est <span class="op">=</span> biomarker_data_est.phi_std[<span class="dv">0</span>]</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>    phi_mean <span class="op">=</span> biomarker_data.phi_mean[<span class="dv">0</span>]</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>    phi_std <span class="op">=</span> biomarker_data.phi_std[<span class="dv">0</span>]</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> theta_mean, theta_std, theta_mean_est, theta_std_est, phi_mean, phi_std, phi_mean_est, phi_std_est</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> make_chart(biomarkers, estimate_df, truth, title):</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    alt.renderers.enable(<span class="st">'png'</span>)</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>    charts <span class="op">=</span> []</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> biomarker <span class="kw">in</span> biomarkers: </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        theta_mean, theta_std, theta_mean_est, theta_std_est, phi_mean, phi_std, phi_mean_est, phi_std_est <span class="op">=</span> obtain_theta_phi_params(</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        biomarker, estimate_df, truth)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        mean1, std1 <span class="op">=</span> theta_mean, theta_std</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        mean2, std2 <span class="op">=</span> theta_mean_est, theta_std_est</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generating points on the x axis</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>        x_thetas <span class="op">=</span> np.linspace(<span class="bu">min</span>(mean1 <span class="op">-</span> <span class="dv">3</span><span class="op">*</span>std1, mean2 <span class="op">-</span> <span class="dv">3</span><span class="op">*</span>std2), </span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">max</span>(mean1 <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>std1, mean2 <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>std2), <span class="dv">1000</span>)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Creating DataFrames for each distribution</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>        df1 <span class="op">=</span> pd.DataFrame({<span class="st">'x'</span>: x_thetas, <span class="st">'pdf'</span>: norm.pdf(x_thetas, mean1, std1), <span class="st">'Distribution'</span>: <span class="st">'Actual'</span>})</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>        df2 <span class="op">=</span> pd.DataFrame({<span class="st">'x'</span>: x_thetas, <span class="st">'pdf'</span>: norm.pdf(x_thetas, mean2, std2), <span class="st">'Distribution'</span>: <span class="st">'Estimated'</span>})</span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combining the DataFrames</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>        df3 <span class="op">=</span> pd.concat([df1, df2])</span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Altair plot</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        chart_theta <span class="op">=</span> alt.Chart(df3).mark_line().encode(</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">'x'</span>,</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">'pdf'</span>,</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>alt.Color(<span class="st">'Distribution:N'</span>, legend<span class="op">=</span>alt.Legend(title<span class="op">=</span><span class="st">"Theta"</span>))</span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        ).properties(</span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>biomarker<span class="sc">}</span><span class="ss">, Theta'</span>,</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>            width<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>            height<span class="op">=</span><span class="dv">100</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>        mean1, std1 <span class="op">=</span> phi_mean, phi_std</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>        mean2, std2 <span class="op">=</span> phi_mean_est, phi_std_est</span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Generating points on the x axis</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>        x_phis <span class="op">=</span> np.linspace(<span class="bu">min</span>(mean1 <span class="op">-</span> <span class="dv">3</span><span class="op">*</span>std1, mean2 <span class="op">-</span> <span class="dv">3</span><span class="op">*</span>std2), </span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">max</span>(mean1 <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>std1, mean2 <span class="op">+</span> <span class="dv">3</span><span class="op">*</span>std2), <span class="dv">1000</span>)</span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Creating DataFrames for each distribution</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>        df1 <span class="op">=</span> pd.DataFrame({<span class="st">'x'</span>: x_phis, <span class="st">'pdf'</span>: norm.pdf(x_phis, mean1, std1), <span class="st">'Distribution'</span>: <span class="st">'Actual'</span>})</span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>        df2 <span class="op">=</span> pd.DataFrame({<span class="st">'x'</span>: x_phis, <span class="st">'pdf'</span>: norm.pdf(x_phis, mean2, std2), <span class="st">'Distribution'</span>: <span class="st">'Estimated'</span>})</span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Combining the DataFrames</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>        df3 <span class="op">=</span> pd.concat([df1, df2])</span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Altair plot</span></span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        chart_phi <span class="op">=</span> alt.Chart(df3).mark_line().encode(</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>            x<span class="op">=</span><span class="st">'x'</span>,</span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>            y<span class="op">=</span><span class="st">'pdf'</span>,</span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>            color<span class="op">=</span>alt.Color(<span class="st">'Distribution:N'</span>, legend<span class="op">=</span>alt.Legend(title<span class="op">=</span><span class="st">"Phi"</span>))</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>        ).properties(</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>            title<span class="op">=</span><span class="ss">f'</span><span class="sc">{</span>biomarker<span class="sc">}</span><span class="ss">, Phi'</span>,</span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>            width<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>            height<span class="op">=</span><span class="dv">100</span></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Concatenate theta and phi charts horizontally</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>        hconcat_chart <span class="op">=</span> alt.hconcat(chart_theta, chart_phi).resolve_scale(color<span class="op">=</span><span class="st">"independent"</span>)</span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Append the concatenated chart to the list of charts</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        charts.append(hconcat_chart)</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Concatenate all the charts vertically</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>    final_chart <span class="op">=</span> alt.vconcat(<span class="op">*</span>charts).properties(title <span class="op">=</span> title)</span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display the final chart</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>    final_chart.display()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-fig-estDistParamsCOPKM" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>make_chart(</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    biomarkers[<span class="dv">0</span>:<span class="dv">4</span>], </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    cop_kmeans_estimates_df, </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    truth_df, </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="st">"Comparing Theta and Phi Distributions Using Constrained K-Means"</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-estdistparamscopkm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-estdistparamscopkm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04_estDistParams_files/figure-html/fig-estdistparamscopkm-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Figure&nbsp;4.1: Comparing Theta and Phi Distributions Using Constrained K-Means"><img src="04_estDistParams_files/figure-html/fig-estdistparamscopkm-output-1.png" width="484" height="708" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-estdistparamscopkm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.1: Comparing Theta and Phi Distributions Using Constrained K-Means
</figcaption>
</figure>
</div>
</div>
</div>
<p>It turns out the result is not very desriable.</p>
</section>
<section id="sec-conjugate-priors" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="sec-conjugate-priors"><span class="header-section-number">4.2</span> Conjugate Priors</h2>
<p>The second method we may utilize is conjugate priors. Conjugacy occurs when the posterior distribution is in the same family of distribution as the prior distribution, but with new parameter values.</p>
<p>Why conjugacy is important? Because without it, one has to do the integration, which oftentimes is hard.</p>
<p>Three major conjugate families:</p>
<ul>
<li>Beta-Binomial</li>
<li>Gamma-Poisson</li>
<li>Normal-Normal</li>
</ul>
<p>In our example, we assume that the measurement data for each biomarker follows a normal distribution; however, we do not know the exact <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>. Our job is to estimate the two parameters for each biomarker based on the data we have.</p>
<p>According to <a href="https://statswithr.github.io/book/inference-and-decision-making-with-multiple-parameters.html#sec:normal-gamma"><em>An Introduction to Bayesian Thinking</em></a> by <span class="citation" data-cites="clydeintroduction">Clyde et al. (<a href="references.html#ref-clydeintroduction" role="doc-biblioref">2022</a>)</span>, if the data comes from a normal distribution with unknown <span class="math inline">\(\mu\)</span> and <span class="math inline">\(\sigma\)</span>, the conjugate prior for <span class="math inline">\(\mu\)</span> has a normal distribution with mean <span class="math inline">\(m_0\)</span> and variance <span class="math inline">\(\frac{\sigma^2}{n_0}\)</span>. The conjugate prior for <span class="math inline">\(\frac{1}{\sigma^2}\)</span> has a Gamma distribution with shape <span class="math inline">\(\frac{v_0}{2}\)</span> and rate <span class="math inline">\(\frac{v_0 s_0^{2}}{2}\)</span> where</p>
<ul>
<li><span class="math inline">\(m_0\)</span>: prior estimate of <span class="math inline">\(\mu\)</span>.</li>
<li><span class="math inline">\(n_0\)</span>: how strongly is the prior belief in <span class="math inline">\(m_0\)</span> is held.</li>
<li><span class="math inline">\(s_0^2\)</span>: prior estimate of <span class="math inline">\(\sigma^2\)</span>.</li>
<li><span class="math inline">\(v_0\)</span>: prior degress of freedome, influencing the certainty of <span class="math inline">\(s_0^2\)</span>.</li>
</ul>
<p>That is to say:</p>
<p><span class="math display">\[\mu | \sigma^2 \sim \mathcal{N}(m_0, \sigma^2/n_0)\]</span></p>
<p><span class="math display">\[1/\sigma^2 \sim Gamma\left(\frac{v_0}{2}, \frac{v_0 s_0^2}{2} \right)\]</span></p>
<p>Combined, we have:</p>
<p><span class="math display">\[(\mu, 1/\sigma^2) \sim NormalGamma(m_0, n_0, s_0^2, v_0)\]</span></p>
<p>The posterior also follows a Normal-Gamma distribution:</p>
<p><span class="math display">\[(\mu, 1/\sigma^2) | data \sim NormalGamma(m_n, n_n, s_n^2, v_n)\]</span></p>
<p>More specifically</p>
<p><span class="math display">\[1/\sigma^2 | data \sim Gamma(v_n/2, s_n^2 v_n/2)\]</span></p>
<p><span class="math display">\[\mu | data, \sigma^2 \sim \mathcal{N}(m_n, \sigma^2/n_n)\]</span></p>
<p>Based on the above two equations, we know that the mean of posterior mean is <span class="math inline">\(m_n\)</span> and the mean of the posterior variance is <span class="math inline">\((s_n^2 v_n/2)/(v_n/2)\)</span>. This is beceause the expected value of <span class="math inline">\(Gamma(\alpha, \beta)\)</span> is <span class="math inline">\(\frac{\alpha}{\beta}\)</span>.</p>
<p>where</p>
<ul>
<li><span class="math inline">\(m_n\)</span>: posterior mean, mode, and median for <span class="math inline">\(\mu\)</span></li>
<li><span class="math inline">\(n_n\)</span>: posterior sample size</li>
<li><span class="math inline">\(s_n^2\)</span>: posterior variance</li>
<li><span class="math inline">\(v_n\)</span>: posterior degrees of freedome</li>
</ul>
<p>The updating rules to get the new hyper-parameters:</p>
<!-- $$m_n = \frac{n \bar{y} + n_0m_0}{n + n_0}$$ -->
<p><span class="math display">\[m_n = \frac{n}{n+n_0} \bar{y} + \frac{n_0}{n+n_0}m_0\]</span></p>
<p><span class="math display">\[n_n = n_0 + n\]</span></p>
<p><span class="math display">\[v_n = v_0 + n\]</span></p>
<p><span class="math display">\[s_n^2 = \frac{1}{v_n}\left[s^2(n-1) + s_0^2v_0 + \frac{n_0n}{n_n}(\bar{y}-m_0)^2\right]\]</span></p>
<p>where</p>
<ul>
<li><span class="math inline">\(n\)</span>: sample size</li>
<li><span class="math inline">\(\bar{y}\)</span>: sample mean</li>
<li><span class="math inline">\(s^2\)</span>: sample variance</li>
</ul>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>To apply the algorithm of conjugate priors, we assume we already know <span class="math inline">\(S\)</span> and <span class="math inline">\(k_j\)</span>, alongside biomarker measurement (<span class="math inline">\(X_{nj}\)</span>). Based on <span class="math inline">\(S\)</span> and <span class="math inline">\(k_j\)</span>, we can infer whether a biomarker is affected by the disease or not.</p>
</div>
</div>
<div id="cell-12" class="cell" data-execution_count="39">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> estimate_params_exact(m0, n0, s0_sq, v0, data):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''This is to estimate means and vars based on conjugate priors</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">        - data: a vector of measurements </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="co">        - m0: prior estimate of $\mu$.</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co">        - n0: how strongly is the prior belief in $m_0$ is held.</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co">        - s0_sq: prior estimate of $\sigma^2$.</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="co">        - v0: prior degress of freedome, influencing the certainty of $s_0^2$.</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="co">        - mu estiate, std estimate</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data summary</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    sample_mean <span class="op">=</span> np.mean(data)</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    sample_size <span class="op">=</span> <span class="bu">len</span>(data)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    sample_var <span class="op">=</span> np.var(data, ddof<span class="op">=</span><span class="dv">1</span>)  <span class="co"># ddof=1 for unbiased estimator</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Update hyperparameters for the Normal-Inverse Gamma posterior</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    updated_m0 <span class="op">=</span> (n0 <span class="op">*</span> m0 <span class="op">+</span> sample_size <span class="op">*</span> sample_mean) <span class="op">/</span> (n0 <span class="op">+</span> sample_size)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>    updated_n0 <span class="op">=</span> n0 <span class="op">+</span> sample_size</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    updated_v0 <span class="op">=</span> v0 <span class="op">+</span> sample_size</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    updated_s0_sq <span class="op">=</span> (<span class="dv">1</span> <span class="op">/</span> updated_v0) <span class="op">*</span> ((sample_size <span class="op">-</span> <span class="dv">1</span>) <span class="op">*</span> sample_var <span class="op">+</span> v0 <span class="op">*</span> s0_sq <span class="op">+</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>                                        (n0 <span class="op">*</span> sample_size <span class="op">/</span> updated_n0) <span class="op">*</span> (sample_mean <span class="op">-</span> m0)<span class="op">**</span><span class="dv">2</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    updated_alpha <span class="op">=</span> updated_v0<span class="op">/</span><span class="dv">2</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    updated_beta <span class="op">=</span> updated_v0<span class="op">*</span>updated_s0_sq<span class="op">/</span><span class="dv">2</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Posterior estimates</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    mu_posterior_mean <span class="op">=</span> updated_m0</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    sigma_squared_posterior_mean <span class="op">=</span> updated_beta<span class="op">/</span>updated_alpha</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    mu_estimation <span class="op">=</span> mu_posterior_mean</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    std_estimation <span class="op">=</span> np.sqrt(sigma_squared_posterior_mean)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> mu_estimation, std_estimation</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_theta_phi_conjugate_priors(biomarkers, data_we_have, theta_phi_kmeans):</span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''To get estimated parameters, returns a hashmap</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a><span class="co">    - biomarkers: biomarkers </span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a><span class="co">    - data_we_have: participants data filled with initial or updated participant_stages</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a><span class="co">    - theta_phi_kmeans: a hashmap of dicts, which are the prior theta and phi values</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a><span class="co">        obtained from the initial constrained kmeans algorithm</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a><span class="co">    Output: </span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="co">    - a hashmap of dictionaries. Key is biomarker name and value is a dictionary.</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a><span class="co">    Each dictionary contains the theta and phi mean/std values for a specific biomarker. </span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    <span class="co"># empty list of dictionaries to store the estimates</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>    hashmap_of_means_stds_estimate_dicts <span class="op">=</span> {}</span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> biomarker <span class="kw">in</span> biomarkers:</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Initialize dictionary outside the inner loop</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>        dic <span class="op">=</span> {<span class="st">'biomarker'</span>: biomarker}</span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> affected <span class="kw">in</span> [<span class="st">'affected'</span>, <span class="st">'not_affected'</span>]:</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            data_full <span class="op">=</span> data_we_have[(data_we_have.biomarker <span class="op">==</span> biomarker) <span class="op">&amp;</span> (</span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>                data_we_have.affected_or_not <span class="op">==</span> affected)]</span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(data_full) <span class="op">&gt;</span> <span class="dv">1</span>:</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>                measurements <span class="op">=</span> data_full.measurement</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>                s0_sq <span class="op">=</span> np.var(measurements, ddof<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>                m0 <span class="op">=</span> np.mean(measurements)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>                mu_estimate, std_estimate <span class="op">=</span> estimate_params_exact(</span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>                    m0<span class="op">=</span>m0, n0<span class="op">=</span><span class="dv">1</span>, s0_sq<span class="op">=</span>s0_sq, v0<span class="op">=</span><span class="dv">1</span>, data<span class="op">=</span>measurements)</span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> affected <span class="op">==</span> <span class="st">'affected'</span>:</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'theta_mean'</span>] <span class="op">=</span> mu_estimate</span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'theta_std'</span>] <span class="op">=</span> std_estimate</span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'phi_mean'</span>] <span class="op">=</span> mu_estimate</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'phi_std'</span>] <span class="op">=</span> std_estimate</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If there is only one observation or not observation at all, resort to theta_phi_kmeans</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>            <span class="co"># YES, IT IS POSSIBLE THAT DATA_FULL HERE IS NULL</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>            <span class="co"># For example, if a biomarker indicates stage of (num_biomarkers), but all participants' stages</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>            <span class="co"># are smaller than that stage; so that for all participants, this biomarker is not affected</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">'not enough data here, so we have to use theta phi estimates from constrained kmeans'</span>)</span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>                <span class="co"># print(theta_phi_kmeans)</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> affected <span class="op">==</span> <span class="st">'affected'</span>:</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'theta_mean'</span>] <span class="op">=</span> theta_phi_kmeans[biomarker][<span class="st">'theta_mean'</span>]</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'theta_std'</span>] <span class="op">=</span> theta_phi_kmeans[biomarker][<span class="st">'theta_std'</span>]</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'phi_mean'</span>] <span class="op">=</span> theta_phi_kmeans[biomarker][<span class="st">'phi_mean'</span>]</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>                    dic[<span class="st">'phi_std'</span>] <span class="op">=</span> theta_phi_kmeans[biomarker][<span class="st">'phi_std'</span>]</span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"biomarker {biomarker} done!")</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        hashmap_of_means_stds_estimate_dicts[biomarker] <span class="op">=</span> dic</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> hashmap_of_means_stds_estimate_dicts</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-13" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>conjugate_prior_theta_phi <span class="op">=</span> get_theta_phi_conjugate_priors(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    biomarkers <span class="op">=</span> biomarkers, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    data_we_have <span class="op">=</span> df, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    theta_phi_kmeans <span class="op">=</span> cop_kmeans_estimates</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>cp_df <span class="op">=</span> pd.DataFrame.from_dict(conjugate_prior_theta_phi, orient<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>cp_df.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>cp_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">biomarker</th>
<th data-quarto-table-cell-role="th">theta_mean</th>
<th data-quarto-table-cell-role="th">theta_std</th>
<th data-quarto-table-cell-role="th">phi_mean</th>
<th data-quarto-table-cell-role="th">phi_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>HIP-FCI</td>
<td>-5.378366</td>
<td>7.233991</td>
<td>5.092800</td>
<td>1.514402</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>PCC-FCI</td>
<td>5.521792</td>
<td>2.777207</td>
<td>12.071769</td>
<td>3.671679</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AB</td>
<td>151.143708</td>
<td>14.806694</td>
<td>251.973564</td>
<td>51.382188</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>P-Tau</td>
<td>-41.768257</td>
<td>34.857945</td>
<td>-24.739527</td>
<td>14.928907</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>MMSE</td>
<td>23.122406</td>
<td>2.446874</td>
<td>28.049683</td>
<td>0.718493</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>ADAS</td>
<td>-19.633304</td>
<td>4.582900</td>
<td>-5.902198</td>
<td>1.278311</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>HIP-GMI</td>
<td>0.425625</td>
<td>0.272876</td>
<td>0.379542</td>
<td>0.235348</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>AVLT-Sum</td>
<td>21.664360</td>
<td>3.755735</td>
<td>40.700638</td>
<td>14.480463</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>FUS-GMI</td>
<td>0.482745</td>
<td>0.055585</td>
<td>0.590434</td>
<td>0.063730</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>FUS-FCI</td>
<td>-18.566905</td>
<td>5.781937</td>
<td>-9.648705</td>
<td>3.099195</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Note
</div>
</div>
<div class="callout-body-container callout-body">
<p>When we estimate <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\phi\)</span> using conjugate priors, we need to use the result from constrained kmeans as a fall back because it is possible that for a specific biomarker, either the <code>affected</code> or the <code>not_affected</code> group is empty. If that is the case, we are not able to estimate relevant parameters and have to resort to the fallback result.</p>
</div>
</div>
<div id="cell-fig-estDistParamsCP" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>make_chart(</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    biomarkers[<span class="dv">0</span>:<span class="dv">4</span>], </span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    cp_df, </span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    truth_df, </span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="st">"Comparing Theta and Phi Distributions Using Conjugate Priors"</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-estdistparamscp" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-estdistparamscp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04_estDistParams_files/figure-html/fig-estdistparamscp-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2" title="Figure&nbsp;4.2: Comparing Theta and Phi Distributions Using Conjugate Prior"><img src="04_estDistParams_files/figure-html/fig-estdistparamscp-output-1.png" width="490" height="704" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-estdistparamscp-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.2: Comparing Theta and Phi Distributions Using Conjugate Prior
</figcaption>
</figure>
</div>
</div>
</div>
<!-- ## Conclusion

The result from conjugate priors looks better than that from constrained kmeans. However, to use conjugate priors, we assume that we know $S$ and $k_j$ for each participant, which are very hardly known. The constrained kmeans algorithm does not require any prior knowledge of $S$ nor $k_j$. -->
</section>
<section id="sec-soft-kmeans" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="sec-soft-kmeans"><span class="header-section-number">4.3</span> Soft K-Means</h2>
<p>Conjugate Priors assumes we know <span class="math inline">\(k_j\)</span>, which often times is not already known. Constrained K-Means is only taking advantage of <span class="math inline">\(X_{nj}\)</span> and whether participants are diseased or not, leaving <span class="math inline">\(S\)</span>, which is known to us, unexploited.</p>
<p>Soft K-Means is a good alternative to these two because it utilizes <span class="math inline">\(S\)</span> while at the same time not assuming we know <span class="math inline">\(k_j\)</span>.</p>
<p>The logic of soft-kmeans is this;</p>
<ol type="1">
<li>If a participant is diseased, we iterate through all possible disease stages, and calculate the associated likelihood using <a href="02_ebmExplain.html#eq-known-kj" class="quarto-xref">Equation&nbsp;<span>2.1</span></a>. We then normalize these likelihoods to obtain the estimated probability of this participant being at each stage. For example, if there are three possible stages, and the associated likelihoods are <code>[1, 3, 6]</code>, then the normalized likelihoods would be <code>[0.1, 0.3, 0.6]</code>.</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may wonder how we can use <a href="02_ebmExplain.html#eq-known-kj" class="quarto-xref">Equation&nbsp;<span>2.1</span></a> when we do not know <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\phi\)</span> yet (which is exactly what we are trying to do!). If you notice this, it is a very keen observation!.</p>
<p>If fact, we are going to use the estimated <span class="math inline">\(\theta\)</span> and <span class="math inline">\(\phi\)</span> we obtained above using constrained K-Means.</p>
</div>
</div>
<ol start="2" type="1">
<li>For each biomarker <span class="math inline">\(n\)</span>, we obtain <span class="math inline">\(S_n\)</span> based on <span class="math inline">\(S\)</span>. Then we iterate through all participants. If this participant is healthy, we include their biomarker measurement in <code>cluster_phi</code>. If this participant is diseased, we compare between <span class="math inline">\(P_{\theta}\)</span> and <span class="math inline">\(P_{\phi}\)</span>. If <span class="math inline">\(S_n = 2\)</span>, then <span class="math inline">\(P_{\theta} = 0.1 + 0.3 = 0.4\)</span> and <span class="math inline">\(P_{\phi} = 0.6\)</span>. Because <span class="math inline">\(P_{\phi}\)</span> is larger, we include this participant’s biomarker measurement in <code>cluster_phi</code>. When the iteration through participants is done, we can calculate the mean and standard deviation of each cluster.</li>
</ol>
<div class="callout callout-style-default callout-tip callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Tip
</div>
</div>
<div class="callout-body-container callout-body">
<p>If <span class="math inline">\(P_{\theta} =  P_{\phi}\)</span>, we randomly assign this participant’s biomarker measurement to a cluster.</p>
</div>
</div>
<div id="cell-18" class="cell" data-execution_count="42">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_single_measurement_likelihood(theta_phi, biomarker, affected, measurement):</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Computes the likelihood of the measurement value of a single biomarker</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co">    We know the normal distribution defined by either theta or phi</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="co">    and we know the measurement. This will give us the probability</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="co">    of this given measurement value. </span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co">    input:</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="co">    - theta_phi: the dictionary containing theta and phi values for each biomarker</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">    - biomarker: an integer between 0 and 9 </span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co">    - affected: boolean </span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="co">    - measurement: the observed value for a biomarker in a specific participant</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">    output: a scalar</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    biomarker_dict <span class="op">=</span> theta_phi[biomarker]</span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    mu <span class="op">=</span> biomarker_dict[<span class="st">'theta_mean'</span>] <span class="cf">if</span> affected <span class="cf">else</span> biomarker_dict[<span class="st">'phi_mean'</span>]</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    std <span class="op">=</span> biomarker_dict[<span class="st">'theta_std'</span>] <span class="cf">if</span> affected <span class="cf">else</span> biomarker_dict[<span class="st">'phi_std'</span>]</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    var <span class="op">=</span> std<span class="op">**</span><span class="dv">2</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> var <span class="op">&lt;=</span> <span class="bu">int</span>(<span class="dv">0</span>) <span class="kw">or</span> np.isnan(measurement) <span class="kw">or</span> np.isnan(mu):</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Invalid values: measurement: </span><span class="sc">{</span>measurement<span class="sc">}</span><span class="ss">, mu: </span><span class="sc">{</span>mu<span class="sc">}</span><span class="ss">, var: </span><span class="sc">{</span>var<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>        likelihood <span class="op">=</span> np.exp(<span class="op">-</span>(measurement <span class="op">-</span> mu)<span class="op">**</span><span class="dv">2</span> <span class="op">/</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>                            (<span class="dv">2</span> <span class="op">*</span> var)) <span class="op">/</span> np.sqrt(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> var)</span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>        likelihood <span class="op">=</span> np.exp(<span class="op">-</span>(measurement <span class="op">-</span> mu)<span class="op">**</span><span class="dv">2</span> <span class="op">/</span></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>                            (<span class="dv">2</span> <span class="op">*</span> var)) <span class="op">/</span> np.sqrt(<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">*</span> var)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> likelihood</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fill_up_kj_and_affected(pdata, k_j):</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''Fill up a single participant's data using k_j; basically add two columns: </span></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co">    k_j and affected</span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co">    Note that this function assumes that pdata already has the S_n column</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a><span class="co">    - pdata: a dataframe of ten biomarker values for a specific participant </span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="co">    - k_j: a scalar</span></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> pdata.copy()</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'k_j'</span>] <span class="op">=</span> k_j</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    data[<span class="st">'affected'</span>] <span class="op">=</span> data.<span class="bu">apply</span>(<span class="kw">lambda</span> row: row.k_j <span class="op">&gt;=</span> row.S_n, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> data</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_likelihood(pdata, k_j, theta_phi):</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">'''</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a><span class="co">    This function computes the likelihood of seeing this sequence of biomarker values </span></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="co">    for a specific participant, assuming that this participant is at stage k_j</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="co">    '''</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> fill_up_kj_and_affected(pdata, k_j)</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    likelihood <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, row <span class="kw">in</span> data.iterrows():</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>        biomarker <span class="op">=</span> row[<span class="st">'biomarker'</span>]</span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>        measurement <span class="op">=</span> row[<span class="st">'measurement'</span>]</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>        affected <span class="op">=</span> row[<span class="st">'affected'</span>]</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>        likelihood <span class="op">*=</span> compute_single_measurement_likelihood(</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>            theta_phi, biomarker, affected, measurement)</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> likelihood</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> obtain_participants_hashmap(</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>        data, </span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>        prior_theta_phi_estimates,</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a><span class="co">    Input:</span></span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a><span class="co">        - data: a pd.dataframe. For exrample, 150|200_3.csv</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a><span class="co">        - prior_theta_phi_estimates, a hashmap of dicts. </span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a><span class="co">            This is the result from constrained kmeans </span></span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a><span class="co">    Output: </span></span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a><span class="co">        - hashmap: a dictionary whose key is participant id</span></span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a><span class="co">            and value value is a dict whose key is stage </span></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a><span class="co">            and value is normalized likelihood</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    <span class="co"># initialize hashmap_of_normalized_stage_likelihood_dicts</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>    participants_hashmap <span class="op">=</span> {}</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>    non_diseased_participants <span class="op">=</span> data[</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>        data.diseased <span class="op">==</span> <span class="va">False</span>][<span class="st">'participant'</span>].unique()</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>    disease_stages <span class="op">=</span> data.S_n.unique()</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> data.participant.unique():</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        dic <span class="op">=</span> defaultdict(<span class="bu">int</span>)</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>        pdata <span class="op">=</span> data[data.participant <span class="op">==</span> p].reset_index(drop <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p <span class="kw">in</span> non_diseased_participants:</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>            dic[<span class="dv">0</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> k_j <span class="kw">in</span> disease_stages:</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>                kj_ll <span class="op">=</span> compute_likelihood(pdata, k_j, prior_theta_phi_estimates)</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>                dic[k_j] <span class="op">=</span> kj_ll</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>            <span class="co"># likelihood sum</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>            sum_ll <span class="op">=</span> <span class="bu">sum</span>(dic.values())</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>            epsilon <span class="op">=</span> <span class="fl">1e-10</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> sum_ll <span class="op">==</span> <span class="dv">0</span>:</span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>                sum_ll <span class="op">=</span> epsilon</span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>            normalized_lls <span class="op">=</span> [l<span class="op">/</span>sum_ll <span class="cf">for</span> l <span class="kw">in</span> dic.values()]</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>            normalized_ll_dict <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(disease_stages, normalized_lls))</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>            participants_hashmap[p] <span class="op">=</span> normalized_ll_dict</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> participants_hashmap </span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_soft_kmeans_for_biomarker(</span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>        data,</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>        biomarker,</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>        participants_hashmap</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""obtain theta, phi estimates using soft kmeans for a single biomarker</span></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a><span class="co">    Inputs:</span></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a><span class="co">        - data: a pd.dataframe. For example, 150|200_3.csv</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a><span class="co">        - biomarker: a str, a certain biomarker name</span></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a><span class="co">        - hashmap: a dict, returned result of obtain_hashmap()</span></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a><span class="co">    Outputs:</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a><span class="co">        - theta_mean, theta_std, phi_mean, phi_std, a tuple of floats</span></span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>    non_diseased_participants <span class="op">=</span> data[</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>        data.diseased <span class="op">==</span> <span class="va">False</span>][<span class="st">'participant'</span>].unique()</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>    disease_stages <span class="op">=</span> data.S_n.unique()</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>     <span class="co"># DataFrame for this biomarker</span></span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a>    biomarker_df <span class="op">=</span> data[</span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a>        data[<span class="st">'biomarker'</span>] <span class="op">==</span> biomarker].reset_index(</span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a>            drop<span class="op">=</span><span class="va">True</span>).sort_values(</span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a>                by <span class="op">=</span> <span class="st">'participant'</span>, ascending <span class="op">=</span> <span class="va">True</span>)</span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract measurements</span></span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>    measurements <span class="op">=</span> np.array(biomarker_df[<span class="st">'measurement'</span>])</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>    this_biomarker_order <span class="op">=</span> biomarker_df.S_n[<span class="dv">0</span>]</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>    affected_cluster <span class="op">=</span> []</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>    non_affected_cluster <span class="op">=</span> []</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> p <span class="kw">in</span> data.participant.unique():</span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> p <span class="kw">in</span> non_diseased_participants:</span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>            non_affected_cluster.append(measurements[p])</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>            normalized_ll_dict <span class="op">=</span> participants_hashmap[p]</span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>            affected_prob <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>                normalized_ll_dict[</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a>                    kj] <span class="cf">for</span> kj <span class="kw">in</span> disease_stages <span class="cf">if</span> kj <span class="op">&gt;=</span> this_biomarker_order)</span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a>            non_affected_prob <span class="op">=</span> <span class="bu">sum</span>(</span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>                normalized_ll_dict[</span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>                    kj] <span class="cf">for</span> kj <span class="kw">in</span> disease_stages <span class="cf">if</span> kj <span class="op">&lt;</span> this_biomarker_order)</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> affected_prob <span class="op">&gt;</span> non_affected_prob:</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>                    affected_cluster.append(measurements[p])</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> affected_prob <span class="op">&lt;</span> non_affected_prob:</span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>                non_affected_cluster.append(measurements[p])</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Assign to either cluster randomly if probabilities are equal</span></span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> np.random.random() <span class="op">&gt;</span> <span class="fl">0.5</span>:</span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>                    affected_cluster.append(measurements[p])</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a>                    non_affected_cluster.append(measurements[p])</span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute means and standard deviations</span></span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a>    theta_mean <span class="op">=</span> np.mean(affected_cluster) <span class="cf">if</span> affected_cluster <span class="cf">else</span> np.nan</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>    theta_std <span class="op">=</span> np.std(affected_cluster) <span class="cf">if</span> affected_cluster <span class="cf">else</span> np.nan</span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    phi_mean <span class="op">=</span> np.mean(</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>        non_affected_cluster) <span class="cf">if</span> non_affected_cluster <span class="cf">else</span> np.nan</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>    phi_std <span class="op">=</span> np.std(non_affected_cluster) <span class="cf">if</span> non_affected_cluster <span class="cf">else</span> np.nan</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> theta_mean, theta_std, phi_mean, phi_std</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> cal_soft_kmeans_for_biomarkers(</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>        data,</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>        participants_hashmap,</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a>        prior_theta_phi_estimates,</span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a>    soft_kmeans_estimates <span class="op">=</span> {}</span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>    biomarkers <span class="op">=</span> data.biomarker.unique()</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> biomarker <span class="kw">in</span> biomarkers:</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a>        dic <span class="op">=</span> {<span class="st">'biomarker'</span>: biomarker}</span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a>        prior <span class="op">=</span> prior_theta_phi_estimates[biomarker]</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a>        theta_mean, theta_std, phi_mean, phi_std <span class="op">=</span> calc_soft_kmeans_for_biomarker(</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a>            data, biomarker, participants_hashmap</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> theta_std <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> math.isnan(theta_std):</span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a>            theta_mean <span class="op">=</span> prior[<span class="st">'theta_mean'</span>]</span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>            theta_std <span class="op">=</span> prior[<span class="st">'theta_std'</span>]</span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> phi_std <span class="op">==</span> <span class="dv">0</span> <span class="kw">or</span> math.isnan(phi_std):</span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a>            phi_mean <span class="op">=</span> prior[<span class="st">'phi_mean'</span>]</span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a>            phi_std <span class="op">=</span> prior[<span class="st">'phi_std'</span>]</span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a>        dic[<span class="st">'theta_mean'</span>] <span class="op">=</span> theta_mean</span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a>        dic[<span class="st">'theta_std'</span>] <span class="op">=</span> theta_std</span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a>        dic[<span class="st">'phi_mean'</span>] <span class="op">=</span> phi_mean</span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a>        dic[<span class="st">'phi_std'</span>] <span class="op">=</span> phi_std</span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>        soft_kmeans_estimates[biomarker] <span class="op">=</span> dic</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> soft_kmeans_estimates</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-19" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>participants_hashmap <span class="op">=</span> obtain_participants_hashmap(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> df, </span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    prior_theta_phi_estimates <span class="op">=</span> cop_kmeans_estimates,</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>soft_kmeans_estimates <span class="op">=</span> cal_soft_kmeans_for_biomarkers(</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> df,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        participants_hashmap <span class="op">=</span> participants_hashmap,</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>        prior_theta_phi_estimates <span class="op">=</span> cop_kmeans_estimates,</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-20" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>soft_kmeans_estimates_df <span class="op">=</span> pd.DataFrame.from_dict(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    soft_kmeans_estimates, orient<span class="op">=</span><span class="st">'index'</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>soft_kmeans_estimates_df.reset_index(drop<span class="op">=</span><span class="va">True</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>soft_kmeans_estimates_df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="44">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">biomarker</th>
<th data-quarto-table-cell-role="th">theta_mean</th>
<th data-quarto-table-cell-role="th">theta_std</th>
<th data-quarto-table-cell-role="th">phi_mean</th>
<th data-quarto-table-cell-role="th">phi_std</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>HIP-FCI</td>
<td>-5.378366</td>
<td>7.232544</td>
<td>5.092800</td>
<td>1.514369</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>PCC-FCI</td>
<td>10.397606</td>
<td>3.698129</td>
<td>10.572261</td>
<td>4.472485</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>AB</td>
<td>157.514640</td>
<td>19.654237</td>
<td>232.546088</td>
<td>61.426283</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>P-Tau</td>
<td>-61.280491</td>
<td>21.704315</td>
<td>-27.032696</td>
<td>20.645375</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>MMSE</td>
<td>21.478486</td>
<td>0.869996</td>
<td>27.414771</td>
<td>1.956947</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>ADAS</td>
<td>-23.386222</td>
<td>3.249392</td>
<td>-7.343264</td>
<td>4.453207</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>HIP-GMI</td>
<td>0.114735</td>
<td>0.106857</td>
<td>0.385654</td>
<td>0.240309</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>AVLT-Sum</td>
<td>60.569081</td>
<td>6.389012</td>
<td>39.177736</td>
<td>14.855928</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>FUS-GMI</td>
<td>0.478209</td>
<td>0.041763</td>
<td>0.584511</td>
<td>0.067892</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>FUS-FCI</td>
<td>-19.200644</td>
<td>4.688806</td>
<td>-10.050024</td>
<td>3.751844</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cell-fig-estDistParamsSKM" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>make_chart(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    biomarkers[<span class="dv">0</span>:<span class="dv">4</span>], </span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    soft_kmeans_estimates_df, </span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    truth_df, </span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> <span class="st">"Comparing Theta and Phi Distributions Using Soft K-Means"</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div id="fig-estdistparamsskm" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-estdistparamsskm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<a href="04_estDistParams_files/figure-html/fig-estdistparamsskm-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3" title="Figure&nbsp;4.3: Comparing Theta and Phi Distributions Using Soft K-Mean"><img src="04_estDistParams_files/figure-html/fig-estdistparamsskm-output-1.png" width="488" height="711" class="figure-img"></a>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-estdistparamsskm-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4.3: Comparing Theta and Phi Distributions Using Soft K-Mean
</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="conclusion" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">4.4</span> Conclusion</h2>
<p>We compare the above three methods. Constrained k-means has the least number of prerequisites: it only needs to know whether participants are healthy or not and biomarker measurements. However, the drawback is that it might not be very accurate. Conjugate priors are extremely accurate; however, it requires knowledge of almost everything: besides what is required by constrained k-kmeans, it also requires <span class="math inline">\(S\)</span> and <span class="math inline">\(k_j\)</span>. Soft k-kmeans does not require the knowledge of <span class="math inline">\(k_j\)</span> and is an improvement over constrained k-means.</p>
<p>We also noticed that both conjugate priors and soft k-means need to use the result from constrained k-means as a fallback.</p>


<div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list" style="display: none">
<div id="ref-behrouz_babaki_2017_831850" class="csl-entry" role="listitem">
Babaki, Behrouz. 2017. <span>“COP-Kmeans Version 1.5.”</span> <a href="https://doi.org/10.5281/zenodo.831850">https://doi.org/10.5281/zenodo.831850</a>.
</div>
<div id="ref-clydeintroduction" class="csl-entry" role="listitem">
Clyde, M, M Cetinkaya-Rundel, C Rundel, D Banks, C Chai, and L Huang. 2022. <span>“An Introduction to Bayesian Thinking: A Companion to the Statistics with r Course. 2020.”</span> <a href="https://statswithr.github.io/book/">https://statswithr.github.io/book/</a>.
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03_gen.html" class="pagination-link" aria-label="Generate Synthetic Data">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Generate Synthetic Data</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05_estStages.html" class="pagination-link" aria-label="Estimate Participant Stages">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Estimate Participant Stages</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<script>var lightboxQuarto = GLightbox({"descPosition":"bottom","selector":".lightbox","loop":false,"closeEffect":"zoom","openEffect":"zoom"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>